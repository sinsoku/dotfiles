#!/bin/bash

ISSUES_PATH=".github/issues"
CACHE_PATH="$ISSUES_PATH/cache"

list() {
  if [ -e "$ISSUES_PATH" ]; then
    for f in $(ls -p $ISSUES_PATH | grep -v / | sort -n --reverse); do
      printf '\e[32m%8s\e[m  ' "#${f%.*}"
      head -n 1 "$ISSUES_PATH/$f" | cut -b 3-
    done
  fi
}

fetch() {
  if [ ! -e "$ISSUES_PATH" ]; then
    mkdir -p "$CACHE_PATH"
  fi

  for n in $(hub issue -f '%I '); do
    hub issue show $n > "$ISSUES_PATH/cache/$n.md"

    if [ ! -e "$ISSUES_PATH/$n.md" ]; then
      cp "$CACHE_PATH/$n.md" "$ISSUES_PATH/$n.md"
    fi
  done
}

push() {
  if [ -e "$ISSUES_PATH" ]; then
    echo 'TODO: push'
  fi
}

usage() {
  echo 'usage: gh-issue <command>'
  echo
  echo '  fetch  Fetch issues from GitHub to local'
  echo '  push   Push issues from local to GitHub'
  echo '  diff   Display diff between GitHub and local'
}

if [ -z "$1" ]; then
  list
else
  case "$1" in
    "list" ) list;;
    "fetch" ) fetch;;
    "push" ) push;;
    * ) usage;;
  esac
fi
